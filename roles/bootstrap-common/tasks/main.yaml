---
- name: Remove node taint
  shell: |
    kubectl --kubeconfig /etc/kubernetes/admin.conf \
    taint nodes {{ inventory_hostname }} \
    node-role.kubernetes.io/master:NoSchedule-
  ignore_errors: yes

- name: Install longhorn
  shell: |
    helm repo add longhorn https://charts.longhorn.io --force-update && \
    helm repo update && \
    kubectl --kubeconfig /etc/kubernetes/admin.conf \
      create namespace longhorn-system && \
    helm --kubeconfig /etc/kubernetes/admin.conf \
      install longhorn longhorn/longhorn --version {{ longhorn_version }} \
      --namespace longhorn-system
